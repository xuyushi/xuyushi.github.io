<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Android Media Player - Xu Yushi's Blog
  
  </title>
  
  
  <link href="atom.xml" rel="alternate" title="Xu Yushi's Blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />
    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
  function before_search(){
    var searchVal = 'site: ' + document.getElementById('search_input').value;
    document.getElementById('search_q').value = searchVal;
    return true;
  }
</script>
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>


  <section class="top-bar-section">
  <div class="row">
      <div style="position: relative;width:100%;"><div style="position: absolute; width:100%;">
        <ul id="main-menu" class="left">
        
        <li id=""><a target="self" href="index.html">Home</a></li>
        
        <li id=""><a target="_self" href="archives.html">Archives</a></li>
        
        </ul>

        <ul class="right" id="search-wrap">
          <li>
<form target="_blank" onsubmit="return before_search();" action="http://google.com/search" method="get">
    <input type="hidden" id="search_q" name="q" value="" />
    <input tabindex="1" type="search" id="search_input"  placeholder="Search"/>
</form>
</li>
          </ul>
      </div></div>
  </div>
  </section>

</nav>

        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; Xu Yushi's Blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
        
        <li><a target="self" href="index.html">Home</a></li>
        
        <li><a target="_self" href="archives.html">Archives</a></li>
        

    <li><label>Categories</label></li>

        
            <li><a href="Android.html">Android</a></li>
        
            <li><a href="UserGrowth.html">UserGrowth</a></li>
        
            <li><a href="balabala.html">balabala</a></li>
        
            <li><a href="Java.html">Java</a></li>
         

      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>


        <section id="main-content" role="main" class="scroll-container">
        
       

 <script type="text/javascript">
  $(function(){
    $('#menu_item_index').addClass('is_active');
  });
</script>
<div class="row">
  <div class="large-8 medium-8 columns">
      <div class="markdown-body article-wrap">
       <div class="article">
          
          <h1>Android Media Player</h1>
     
        <div class="read-more clearfix">
          <span class="date">2015/11/27</span>

          <span>posted in&nbsp;</span> 
          
              <span class="posted-in"><a href='Android.html'>Android</a></span>
           
         
          <span class="comments">
            

            
          </span>

        </div>
      </div><!-- article -->

      <div class="article-content">
      <h2 id="toc_0">Audio Stream</h2>

<p>Androidä¸ºä¸åŒçš„åº”ç”¨åœºåˆå®šä¹‰äº†ä¸åŒçš„Audio Stream: Voice Call, Ring, Music,Alarm, Notification, DTMFã€‚ è¿™äº›AudioStreamæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ‰€ä»¥ä¹Ÿæœ‰å„è‡ªçš„éŸ³é‡</p>

<h2 id="toc_1">ä½¿ç”¨</h2>

<p>æœ€é‡è¦çš„ç±»æ˜¯ <code>MediaPlayer</code>ï¼Œè·å–ã€è§£ç ã€æ’­æ”¾<br/>
æ’­æ”¾ res/raw ä¸­çš„æ–‡ä»¶ ä¸¾ä¸ªğŸŒ°</p>

<pre><code class="language-java">MediaPlayer mediaPlayer = MediaPlayer.create(context, R.raw.sound_file_1);
mediaPlayer.start(); // no need to call prepare(); create() does that for you
</code></pre>

<h3 id="toc_2">å¼‚æ­¥å‡†å¤‡</h3>

<p>å¯èƒ½éœ€è¦æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œmedia éœ€è¦è·å–èµ„æºå’Œè§£ç ï¼Œæœ€å¥½ä¸è¦æ”¾åœ¨ UI çº¿ç¨‹ã€‚<br/>
æ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>prepareAsync()</code>æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åå°è¿è¡Œï¼Œå½“å‡†å¤‡å·¥èµ„å°±ç»ªä¹‹ååœ¨<code>MediaPlayer.OnPreparedListener</code>è¿”å›ï¼Œå¯ä»¥åœ¨å›è°ƒå‡½æ•°<code>setOnPreparedListener()</code>ä¸­è®¾ç½®</p>

<pre><code class="language-java">mediaPlayer.prepareAsync();
mediaPlayer.setOnPreparedListener(new MediaPlayer.OnPreparedListener() {
    @Override
    public void onPrepared(MediaPlayer mp) {
        // TODO: 15/10/27  
    }
});
</code></pre>

<span id="more"></span><!-- more -->

<h3 id="toc_3">ç®¡ç†çŠ¶æ€</h3>

<p>player æœ‰ç‰¹æœ‰çš„çŠ¶æ€ï¼Œå½“æ“ä½œ player æ—¶åªèƒ½å½“ player å¤„ç†ç‰¹å®šçš„çŠ¶æ€ä¸­ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸æˆ–è€…å…¶ä»–ä¸€äº›æƒ³ä¸åˆ°çš„æƒ…å†µã€‚<br/>
ä¸¾ä¸ªğŸŒ°ï¼Œå½“ creatä¸€ä¸ªæ–°<code>MediaPlayer</code>æ—¶ï¼Œä»–å¤„äº<em>idle</em>çŠ¶æ€ï¼Œåœ¨è¿™ä¸ªçŠ¶æ€ä¸­ï¼Œå¯ä»¥åˆå§‹åŒ–ï¼Œè°ƒç”¨<code>setDataSource()</code>ï¼Œè¿™æ ·å°±è¿›å…¥äº†<em>Initialized</em> çŠ¶æ€ï¼Œæ¥ç€æˆ‘ä»¬è°ƒç”¨<code>prepare()</code>æˆ–è€… <code>prepareAsync()</code>ï¼Œå½“<code>MediaPlayer</code>å‡†å¤‡å®Œå…¨ä¹‹åï¼Œä¼šè¿›å…¥<em>Prepared</em>çŠ¶æ€ï¼Œå½“<code>start()</code>æ’­æ”¾ä¹‹åï¼Œå¯ä»¥è°ƒç”¨ paused stopped ç­‰ï¼›</p>

<p>çŠ¶æ€æµç¨‹å¦‚å›¾<br/>
<img src="http://developer.android.com/images/mediaplayer_state_diagram.gif" alt="çŠ¶æ€æµç¨‹"/></p>

<h3 id="toc_4">é‡Šæ”¾MediaPlayer</h3>

<p>MediaPlayerä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œå½“ä¸åœ¨éœ€è¦çš„æ—¶å€™éœ€è¦ç”¨<code>release()</code>é‡Šæ”¾ï¼Œ</p>

<pre><code class="language-java">mediaPlayer.release();
mediaPlayer = null;
</code></pre>

<h2 id="toc_5">ä½¿ç”¨ Service MediaPlayer</h2>

<p>â€¦â€¦â€¦â€¦</p>

<h2 id="toc_6">audio focus</h2>

<p>æŒ‰ç…§AudioFocusçš„æœºåˆ¶ï¼Œåœ¨ä½¿ç”¨Audioä¹‹å‰ï¼Œéœ€è¦ç”³è¯·AudioFocusï¼Œåœ¨è·å¾—AudioFocusä¹‹åæ‰å¯ä»¥ä½¿ç”¨Audioï¼›å¦‚æœæœ‰åˆ«çš„ç¨‹åºç«äº‰ä½ æ­£åœ¨ä½¿ç”¨çš„Audioï¼Œä½ çš„ç¨‹åºéœ€è¦åœ¨æ”¶åˆ°é€šçŸ¥ä¹‹ååšåœæ­¢æ’­æ”¾æˆ–è€…é™ä½å£°éŸ³çš„å¤„ç†ã€‚å€¼å¾—æŒ‡å‡ºçš„æ˜¯ï¼Œè¿™ç§æœºåˆ¶æ˜¯éœ€è¦åˆä½œå®Œæˆçš„ï¼Œéœ€è¦æ‰€æœ‰ä½¿ç”¨Audioèµ„æºçš„ç¨‹åºéƒ½æŒ‰ç…§è¿™ç§æœºåˆ¶æ¥åšï¼Œè€Œå¦‚æœæœ‰ç¨‹åºåœ¨å®ƒå¤±å»AudioFocusçš„æ—¶å€™ä»ç„¶åœ¨ä½¿ç”¨Audioï¼ŒAudioFocusæ‹¿å®ƒä¹Ÿæ²¡åŠæ³•ã€‚è€Œè¿™ä¸€ç‚¹å¯¹äºå¼€æ”¾ç³»ç»Ÿçš„Androidæ¥è¯´å¾ˆè‡´å‘½çš„ï¼šç”¨æˆ·å¯èƒ½å®‰è£…æ²¡éµå®ˆè¿™ç§æœºåˆ¶çš„ç¨‹åºï¼Œæˆ–è€…ç‰ˆæœ¬å¤ªè€è¿˜æ²¡å¼•å…¥è¿™ç§æœºåˆ¶çš„ç¨‹åºï¼Œè¿™æœ€ç»ˆä¼šå¯¼è‡´å¾ˆå·®çš„ç”¨æˆ·ä½“éªŒã€‚</p>

<p>å½“åº”ç”¨éœ€è¦æ’­æ”¾å£°éŸ³æˆ–è€… notification æ—¶ï¼Œéœ€è¦è¯·æ±‚audio focusï¼Œä¸€æ—¦è·å–ç„¦ç‚¹ä¹‹åï¼Œä¾¿å¯ä»¥æ’­æ”¾å£°éŸ³ï¼Œå¦‚æœæœ‰å¾ˆå¤šåˆ«çš„audio focusï¼Œè¦ä¹ˆåœæ­¢æ’­æ”¾æ­¤æ—¶çš„éŸ³ä¹ï¼Œæˆ–è€…<em>lower it to a quiet level</em>ï¼Œå†ä¹‹åè·å–audio focusç»§ç»­æ’­æ”¾</p>

<p>è·å–/æ”¾å¼ƒAudioFocusçš„æ–¹æ³•éƒ½åœ¨android.media.AudioManagerä¸­ï¼Œè·å–AudioFocusç”¨<code>requestAudioFocus()</code>ï¼›ç”¨å®Œä¹‹åï¼Œæ”¾å¼ƒAudioFocusï¼Œç”¨<code>abandonAudioFocus()</code>ã€‚</p>

<p>ä¸¾ğŸŒ°</p>

<pre><code class="language-java">AudioManager audioManager = (AudioManager) getSystemService(Context.AUDIO_SERVICE);
int result = audioManager.requestAudioFocus(this, AudioManager.STREAM_MUSIC,
    AudioManager.AUDIOFOCUS_GAIN);

if (result != AudioManager.AUDIOFOCUS_REQUEST_GRANTED) {
    // could not get audio focus.
}
</code></pre>

<p><code>requestAudioFocus()</code>çš„ç¬¬ä¸€ä¸ªå‚æ•° æ˜¯<code>AudioManager.OnAudioFocusChangeListener</code>å…¶ä¸­çš„<code>onAudioFocusChange()</code>æ–¹æ³•<br/>
ğŸŒ° </p>

<pre><code class="language-java">class MyService extends Service
                implements AudioManager.OnAudioFocusChangeListener {
    // ....
    public void onAudioFocusChange(int focusChange) {
        // Do something based on focus change...
    }
}

</code></pre>

<p>å…¶onAudioFocusChange()æ–¹æ³•æ˜¯Audio Focusè¢«æŠ¢å ä¸å†æ¬¡è·å¾—é€šçŸ¥çš„åœ°æ–¹ã€‚æ‰€ä»¥ï¼Œæ¯ä¸ªè¦ä½¿ç”¨AudioFocusçš„ç¨‹åºéƒ½è¦å°å¿ƒå®ç°è¿™ä¸ªå‡½æ•°ï¼Œä¿è¯AudioFocuså®ç°çš„ä¸€è‡´æ€§ã€‚ç”³è¯·æˆåŠŸä¹‹åç›‘å¬AudioFocusä½¿ç”¨æƒ…å†µçš„Listenerï¼Œå‚æ•° <code>foucsChange</code></p>

<ul>
<li><code>AUDIOFOCUS_GAIN</code>:è·å–åˆ°äº†ç„¦ç‚¹</li>
<li><code>AUDIOFOCUS_LOSS</code>:å¤±å»ç„¦ç‚¹å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œå¿…é¡»åœæ­¢æ‰€æœ‰çš„ audio playbackï¼Œæ­¤æ—¶å¯ä»¥é‡Šæ”¾èµ„æºäº†ï¼Œæ¯”å¦‚é‡Šæ”¾ <code>MediaPlayer</code></li>
<li><code>AUDIOFOCUS_LOSS_TRANSIENT</code>:æš‚æ—¶å¤±å»ç„¦ç‚¹ï¼Œä½†æ˜¯ä¼šä¹‹åè·å–åˆ°ç„¦ç‚¹ã€‚æ­¤æ—¶å¿…é¡»åœæ­¢æ’­æ”¾ï¼Œä½†æ˜¯èµ„æºä¸å¿…é‡Šæ”¾ï¼Œå› ä¸ºä¹‹åä¼šè·å–ç„¦ç‚¹</li>
<li><code>AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK</code>: æš‚æ—¶å¤±å»ç„¦ç‚¹ï¼Œä½†æ˜¯å…è®¸ç»§ç»­å°å£°çš„æ’­æ”¾éŸ³ä¹ï¼Œè€Œä¸å¿…å…³é—­æ’­æ”¾
ä¸¾ä¸ªğŸŒ°</li>
</ul>

<pre><code class="language-java">public void onAudioFocusChange(int focusChange) {
    switch (focusChange) {
        case AudioManager.AUDIOFOCUS_GAIN:
            // resume playback
            if (mMediaPlayer == null) initMediaPlayer();
            else if (!mMediaPlayer.isPlaying()) mMediaPlayer.start();
            mMediaPlayer.setVolume(1.0f, 1.0f);
            break;

        case AudioManager.AUDIOFOCUS_LOSS:
            // Lost focus for an unbounded amount of time: stop playback and release media player
            if (mMediaPlayer.isPlaying()) mMediaPlayer.stop();
            mMediaPlayer.release();
            mMediaPlayer = null;
            break;

        case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT:
            // Lost focus for a short time, but we have to stop
            // playback. We don&#39;t release the media player because playback
            // is likely to resume
            if (mMediaPlayer.isPlaying()) mMediaPlayer.pause();
            break;

        case AudioManager.AUDIOFOCUS_LOSS_TRANSIENT_CAN_DUCK:
            // Lost focus for a short time, but it&#39;s ok to keep playing
            // at an attenuated level
            if (mMediaPlayer.isPlaying()) mMediaPlayer.setVolume(0.1f, 0.1f);
            break;
    }
}
</code></pre>

<p>ä¸‹é¢çš„æ—¶åºå›¾æè¿°äº†AudioFocusè¢«æŠ¢å ä¸å†æ¬¡è·å–çš„å…¸å‹åœºæ™¯<br/>
<img src="http://my.csdn.net/uploads/201204/03/1333406240_6856.jpg" alt=""/></p>

<ul>
<li>AudioFocus Clienté€šè¿‡requestAudioFocus()è·å–AudioFocusï¼Œåœ¨è·å¾—AudioFocusä¹‹åï¼Œå¼€å§‹æ’­æ”¾Audio[Step#1 ~ #2]ï¼›</li>
<li>å…¶å®ƒç¨‹åºï¼ˆOther Appï¼‰ä¹Ÿé€šè¿‡requestAudioFocus()è·å–AudioFocus [Step#3]</li>
<li>AudioFocus Clientå¤±å»äº†Audio Focusï¼Œåœ¨onAudioFocusChanged()ä¸­ï¼Œæ ¹æ®focusChangeã€focusChangeçš„å€¼ä¸Other Appç”³è¯·æ—¶çš„durationHintç›¸åï¼Œå³focusChange = -1*durationHintã€‘çš„å€¼ï¼Œåšç¬¬äºŒèŠ‚ä¸­æ‰€æè¿°çš„å¤„ç†[Step#4]ï¼›</li>
<li>å…¶å®ƒç¨‹åºï¼ˆOther Appï¼‰è·å–Audio Focusä¹‹åï¼Œå¼€å§‹æ’­æ”¾Audio[Step#5]ï¼›</li>
<li>å…¶å®ƒç¨‹åºï¼ˆOther Appï¼‰ä½¿ç”¨Audioä¹‹åï¼Œé€šè¿‡abandonAudioFocus()å½’è¿˜AudioFocus [Step#6]ï¼›</li>
<li>AudioFocus Clienté‡æ–°è·å¾—äº†Audio Focusï¼Œå¯åšè¿›ä¸€æ­¥çš„å¤„ç† [Step#7]</li>
</ul>

<p>AudioFocusä¸­è™½ç„¶æŠŠAudioStreamä½œä¸ºå‚æ•°ï¼Œä½†æ˜¯AudioFocusçš„å†…éƒ¨è£å†³æœºåˆ¶å¹¶æœªé’ˆå¯¹AudioStreamåšä»€ä¹ˆç‰¹åˆ«çš„å¤„ç†ã€‚AudioFocusçš„å¤„ç†é’ˆå¯¹æ‰€æœ‰çš„ç”³è¯·è€…æ¥è¯´çš„ï¼Œé™¤äº†å®ƒè‡ªèº«å†…éƒ¨ä½œä¸ºAlertçš„ç”³è¯·è€…æœ‰ç‚¹ç‰¹æ®Šå¤–ï¼Œå…¶å®ƒä¸€å¾‹å¹³ç­‰ã€‚</p>


    

      </div>

      <div class="row">
        <div class="large-6 columns">
        <p class="text-left" style="padding:15px 0px;">
      
          <a href="15299133099014.html" 
          title="Previous Post: VIM æŠ€å·§">&laquo; VIM æŠ€å·§</a>
      
        </p>
        </div>
        <div class="large-6 columns">
      <p class="text-right" style="padding:15px 0px;">
      
          <a  href="15299133099732.html" 
          title="Next Post: Android View å°ç»“ï¼ˆä¸‹ï¼‰">Android View å°ç»“ï¼ˆä¸‹ï¼‰ &raquo;</a>
      
      </p>
        </div>
      </div>
      <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div>
    </div><!-- article-wrap -->
  </div><!-- large 8 -->




 <div class="large-4 medium-4 columns">
  <div class="hide-for-small">
    <div id="sidebar" class="sidebar">
          <div id="site-info" class="site-info">
            
                <h1>Xu Yushi's Blog</h1>
                <div class="site-des">ç†å·¥ç”·çš„ç¢ç¢å¿µ</div>
                <div class="social">











  <a target="_blank" class="rss" href="atom.xml" title="RSS">RSS</a>
                
              	 </div>
          	</div>

             

              <div id="site-categories" class="side-item ">
                <div class="side-header">
                  <h2>Categories</h2>
                </div>
                <div class="side-content">

      	<p class="cat-list">
        
            <a href="Android.html"><strong>Android</strong></a>
        
            <a href="UserGrowth.html"><strong>UserGrowth</strong></a>
        
            <a href="balabala.html"><strong>balabala</strong></a>
        
            <a href="Java.html"><strong>Java</strong></a>
         
        </p>


                </div>
              </div>

              <div id="site-categories" class="side-item">
                <div class="side-header">
                  <h2>Recent Posts</h2>
                </div>
                <div class="side-content">
                <ul class="posts-list">
	      
		      
			      <li class="post">
			        <a href="15299133098726.html">abtest æ•°æ®åˆ†æ</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15299133098793.html">ABtest å¹³å°æ¡†æ¶</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15299133099414.html">å†™åœ¨ç¦»å¼€åŒ—äº¬çš„å‰å¤•</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15299133099249.html">jenkins å¹³å°æ­å»º</a>
			      </li>
		     
		  
		      
			      <li class="post">
			        <a href="15299133099310.html">gitlab æ­å»º</a>
			      </li>
		     
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		  
		      
		   
		  		</ul>
                </div>
              </div>
        </div><!-- sidebar -->
      </div><!-- hide for small -->
</div><!-- large 4 -->

</div><!-- row -->

 <div class="page-bottom clearfix">
  <div class="row">
   <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
</div>

        </section>
      </div>
    </div>

  
    

    <script src="asset/js/foundation.min.js"></script>
    <script>
      $(document).foundation();
      function fixSidebarHeight(){
        var w1 = $('.markdown-body').height();
          var w2 = $('#sidebar').height();
          if (w1 > w2) { $('#sidebar').height(w1); };
      }
      $(function(){
        fixSidebarHeight();
      })
      $(window).load(function(){
          fixSidebarHeight();
      });
     
    </script>

    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>


  </body>
</html>
